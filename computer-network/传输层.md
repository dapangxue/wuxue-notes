# 传输层

## 一、TCP

### 流量控制

TCP的流量控制主要是由接收方决定发送方的发送情况。在TCP传输的报文结构中，接收方会返回给发送方它当前的rwnd的大小，用于调整发送方的发送窗口的大小。一般来讲发送串口有左沿和右沿，也就是根据接收方返回的rwnd的大小来修改发送方发送窗口的左沿和右沿。

### 可靠性/差错控制

TCP使用差错控制保证了传输数据段的可靠性。差错控制主要包括了TCP数据头的校验和，确认机制和超时机制。

TCP的每一段数据的TCP头部都包含了校验和信息，用于检查当前的报文段是否损坏，如果损坏，就将当前的报文段丢弃掉。

TCP的确认机制保证了数据的可靠传输，比如ACK和SACK，其中SACK较为特殊，它向发送方报告额外的信息，它报告失序的字节块和重复的字节块，TCP的头部是20个字节~60个字节，SACK利用TCP头部的末端，将信息反馈回去。

超时机制，TCP中的超时情况有超时重传和三次重复ACK之后的快速重传。发生了数据传输的超时，说明在网络中发生了拥塞，TCP的超时重传，意味着在一段数据段发送出去之后，在重传超时（RTO）时间内没有接收到接收方的确认，这个时候触发重传，此时认为网络发生了严重的拥塞。如果发送方接收到三次连续重复的ACK，此时认为网络发生了轻微的拥塞，发送方立即重发缺失的段。

### 拥塞控制

TCP传输过程中实际的窗口大小由拥塞窗口（cwnd）和接收端的接收窗口（rwnd）决定。

TCP的拥塞检测主要就是发生了超时和接收到三次重复的ACK，发生超时，意味着网络发生了严重的拥塞。接收到三次重复的ACK，意味着发生了轻微拥塞。

拥塞控制的拥塞策略主要有：

+ 慢启动（slow start）

慢启动是一个指数增加的过程，每当一个确认到达，就增加一个MSS。

+ 拥塞避免

拥塞避免是一个加性增加的过程，在拥塞避免阶段，一个窗口内的所有段都被都被确认后，MSS才加1。

+ 快速恢复

快速恢复开始于三次重复的ACK到达，这种网络的轻微拥塞的情况下，每当一个重复的ACK到达，它增加拥塞窗口的大小。在旧版本的TCP中是不使用快速恢复策略的。

旧版的TCP版本Taho中，不论是发生超时还是发生三次重复的ACK的情况，都会使得拥塞策略变为慢启动，阈值转为当前cwnd值的一半。

在Reno TCP版本中，拥有了快速恢复策略，接收到三次重复的ACK的情况下进入快速恢复状态，如果再次接收到新的ACK，进入拥塞避免状态。